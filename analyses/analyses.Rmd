---
title: "The Generic Pattern among IRAP effects"
author: "Ian Hussey"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r, include=FALSE}
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE,
                      fig.height = 3, 
                      fig.width = 6)
```

```{r}

# dependencies ----------------------------------------------------------------------------

library(tidyverse)
library(schoRsch)
library(knitr)
library(kableExtra)
library(ez)
library(schoRsch)
library(plotrix)
library(BayesFactor)
library(rsample)
library(broom)
library(purrr)
library(patchwork)
library(lme4)
library(sjPlot)

# function to round all numeric vars in a data frame
round_df <- function(df, n_digits = 3) {
  df %>% mutate_if(is.numeric, round, digits = n_digits)
}

# table format in output
options(knitr.table.format = "html") 

# disable scientific notation
options(scipen = 999) 

# set seed
set.seed(42)

# n bootstrap iterations
n_boots <- 2000

```

# Data

```{r}

# get data
data_processed <- read_csv("../data/scored/data_scored.csv")

# exclusions
data_processed_outliers_removed <- data_processed %>%
  filter(rt_outlier == FALSE) %>%
  select(-D_overall)

# d scoring
data_long <- data_processed_outliers_removed %>%
  rename("Category 1\npositive" = D_tt1, 
         "Category 1\nnegative" = D_tt2, 
         "Category 2\npositive" = D_tt3, 
         "Category 2\nnegative" = D_tt4,
         Domain = domain) %>%
  gather(trial_type, D, c("Category 1\npositive",
                          "Category 1\nnegative",
                          "Category 2\npositive",
                          "Category 2\nnegative")) %>%
  mutate(trial_type = fct_relevel(trial_type,
                                  "Category 1\npositive",
                                  "Category 1\nnegative",
                                  "Category 2\npositive",
                                  "Category 2\nnegative"),
         Domain = as.factor(Domain),
         unique_id = as.factor(unique_id))

data_long_known_stimuli <- data_long %>%
  filter(Domain != "Non-words")

data_long_unknown_stimuli <- data_long %>%
  mutate(Stimuli = as.factor(ifelse(Domain == "Non-words", "Non-words", "Known words")))

```

# Demographics

```{r}

# excluded
data_processed %>% 
  summarize(n_total = n()) %>% 
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

data_processed %>% 
  filter(rt_outlier == FALSE) %>% 
  summarize(n_excluded = n()) %>% 
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

# sample descriptives
data_processed %>%
  dplyr::summarise(age_mean = round(mean(age, na.rm = TRUE), 1),
                   age_sd = round(sd(age, na.rm = TRUE), 1)) %>% 
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

data_processed %>%
  count(gender) %>% 
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

N participants by IRAP domain after exclusions

```{r}

data_processed_outliers_removed %>%
  count(domain) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

# Analyses

## Comparing domains

### Estimate generic pattern via meta analysis

NB plotting uses hard coded values - must update if results were to change due to data processing changes etc!

```{r, fig.height=3, fig.width=5.5}

fit <- lmer(D ~ trial_type + (1 | Domain) + (1 | unique_id), 
            data = data_long_known_stimuli)

tab_model(fit, digits = 3)

data_generic_pattern <- 
  data.frame(trial_type = c("Category 1\npositive",
                            "Category 1\nnegative",
                            "Category 2\npositive",
                            "Category 2\nnegative"),
             D_mean     = c(0.112, 0.112-0.065, 0.112-0.174, 0.112-0.103),
             D_ci_lower = c(0.098, 0.112-0.078, 0.112-0.187, 0.112-0.116),
             D_ci_upper = c(0.126, 0.112-0.053, 0.112-0.162, 0.112-0.091),
             dummy = c("dummy", "dummy", "dummy", "dummy"))

p0 <-
  data_generic_pattern %>%
  separate(trial_type, into = c("Category", "Attribute"), sep = "\n") %>%
  mutate(Attribute = recode(Attribute,
                            "positive" = "Positive",
                            "negative" = "Negative"),
         Attribute = fct_relevel(Attribute, "Positive", "Negative"),
         D_mean = ifelse(Category == "Category 2", D_mean*-1, D_mean),
         D_ci_lower = ifelse(Category == "Category 2", D_ci_lower*-1, D_ci_lower),
         D_ci_upper = ifelse(Category == "Category 2", D_ci_upper*-1, D_ci_upper)) %>%
  ggplot(aes(Category, D_mean, color = Attribute)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_point() +
  geom_line(aes(group = Attribute, 
                linetype = Attribute,
                color = Attribute)) +
  geom_linerange(aes(ymin = D_ci_lower, 
                     ymax = D_ci_upper, 
                     group = Attribute, 
                     color = Attribute)) +
  scale_color_viridis_d(begin = 0.3, end = 0.7, direction = -1) +
  ylab(expression(paste(italic("D"), " score"))) +
  scale_linetype_manual(values = c("solid", "longdash"))+
  theme_minimal()

p0

```

### Plot

```{r, fig.height=6, fig.width=10}

data_D_scores_summary <- data_long_known_stimuli %>%
  group_by(Domain, trial_type) %>%
  summarize(D_mean = mean(D, na.rm = TRUE),
            D_ci_lower = D_mean - 1.96*std.error(D, na.rm = TRUE),
            D_ci_upper = D_mean + 1.96*std.error(D, na.rm = TRUE)) %>%
  ungroup() 

p1 <- ggplot() +
  geom_linerange(data = data_D_scores_summary, 
                 aes(x = trial_type, 
                     y = D_mean, 
                     colour = Domain, 
                     group = Domain,
                     ymin = D_ci_lower,
                     ymax = D_ci_upper), 
                 position = position_dodge(width = .25)) +
  geom_linerange(data = data_generic_pattern, 
                 aes(x = trial_type, 
                     y = D_mean, 
                     group = dummy,
                     ymin = D_ci_lower,
                     ymax = D_ci_upper),
                 size = 1,
                 position = position_dodge(width = .25)) +
  geom_line(data = data_D_scores_summary, 
            aes(x = trial_type, 
                y = D_mean, 
                colour = Domain, 
                group = Domain),
            position = position_dodge(width = .25), 
            alpha = 0.6) +
  geom_line(data = data_generic_pattern, 
            aes(x = trial_type, y = D_mean, group = dummy), 
            size = 1,
            position = position_dodge(width = .25)) +
  geom_hline(yintercept = c(0), linetype = "dotted") +
  ylab(expression(paste(italic("D"), " score"))) +
  xlab("Trial type") +
  #theme(legend.position = "bottom") +
  #theme_classic()
  theme_minimal()

p1

```

### Bayes Factors 

These use the equivalent of frequentist type II sum of squares model comparisons for the main effects. 

- BF for the evidence for domain is the BF(D ~ trial_type + domain + unique_id)/BF(D ~ trial_type + unique_id)
- BF for the evidence for trial type is the BF(D ~ trial_type + domain + unique_id)/BF(D ~ domain + unique_id)

And the equivalent of frequentist type III sum of squares model comparisons for the interaction effect.

- BF for the evidence for trial type is the BF(D ~ trial_type + domain + trial_type:domain + unique_id)/BF(D ~ trial_type + domain + unique_id)

```{r}

if (file.exists("models/fit_bf_anova.RData")) {
  
  load("models/fit_bf_anova.RData")

} else {

  fit_bf_anova <-
    anovaBF(formula = D ~ trial_type * Domain + unique_id,
            data = data_long_known_stimuli,
            whichRandom = c("unique_id"),
            multicore = TRUE)
  
  save(fit_bf_anova, file = "models/fit_bf_anova.RData")
  
}

# BF inclusions (between multiple alternative models)
bf_inclusion_domain      <- fit_bf_anova[3] / fit_bf_anova[2]
bf_inclusion_trial_type  <- fit_bf_anova[3] / fit_bf_anova[1]
bf_inclusion_interaction <- fit_bf_anova[4] / fit_bf_anova[3]

```

- Domain BF10 = `r round(exp(bf_inclusion_domain@bayesFactor$bf), 4)`
- Trial type BF10 =  `r round(exp(bf_inclusion_trial_type@bayesFactor$bf), 2)`
- Interaction effect BF10 = `r round(exp(bf_inclusion_interaction@bayesFactor$bf), 4)`

### Frequentist 

```{r}

fit_anova_freq <- ez::ezANOVA(data     = data_long_known_stimuli,
                              dv       = D,
                              within   = trial_type,
                              between  = Domain,
                              wid      = unique_id,
                              type     = 3,
                              detailed = TRUE)

anova_out(fit_anova_freq, 
          etasq = "partial", 
          sph.cor = "no",
          print = FALSE)$`--- FORMATTED RESULTS ------------------------------------` 

```

### Effect sizes

Comparison of frequentist effect sizes: eta squared, partial eta squared, and generalized eta squared.

Bootstrapping via case removal and percentile method with 2000 replications.

```{r}

if (file.exists("models/boot_fits.RData")) {
  
  load("models/boot_fits.RData")

} else {
  
  # create bootstraps using out of bag method. makes a df with values that are collapsed dfs.
  boots <- data_long_known_stimuli %>%
    # reshape so that participants are sampled between bootstraps
    select(unique_id, Domain, trial_type, D) %>%
    spread(trial_type, D) %>%
    rename(tt1 = `Category 1\npositive`,
           tt2 = `Category 1\nnegative`,
           tt3 = `Category 2\npositive`,
           tt4 = `Category 2\nnegative`) %>%
    # create bootstraps
    bootstraps(times = n_boots)
  
  # analysis workflow to be bootstrapped
  helper_function <- function(split) {
    
    fit_anova_freq <- analysis(split) %>%
      # undo reshaping
      gather(trial_type, D, c("tt1", "tt2", "tt3", "tt4")) %>%
      # fit anova
      ez::ezANOVA(data     = .,
                  dv       = D,
                  within   = trial_type,
                  between  = Domain,
                  wid      = unique_id,
                  type     = 3,
                  detailed = TRUE)
    
    # eta squared and generalized eta squared
    results_etasq <- 
      fit_anova_freq$ANOVA %>%
      mutate(etasq = SSn / sum(SSn)) %>%
      select(Effect, etasq) %>%
      round_df(2)
    
    # partial eta squared
    results_petasq_and_getasq <- 
      anova_out(fit_anova_freq, 
                etasq = "partial", 
                sph.cor = "no",
                print = FALSE)$`--- ANOVA RESULTS     ------------------------------------` %>%
      mutate(petasq = as.numeric(as.character(petasq)),
             getasq = as.numeric(as.character(getasq))) %>%
      select(Effect, petasq, getasq)
    
    # combine
    results_proportion_of_variance <- 
      left_join(results_etasq, results_petasq_and_getasq, by = "Effect")
    
    return(results_proportion_of_variance)
  }
  
  # apply to each bootstrap
  boot_fits <- boots %>% 
    mutate(fit = map(splits, helper_function)) %>%
    unnest(fit) 
  
  save(boot_fits, file = "models/boot_fits.RData")

}

boot_estimates <- boot_fits %>%
    # find CIs using percentile method
    group_by(Effect) %>%
    summarize(etasq_median    = quantile(etasq,  0.50),
              etasq_ci_lower  = quantile(etasq,  0.05),
              etasq_ci_upper  = quantile(etasq,  0.95),
              petasq_median   = quantile(petasq, 0.50),
              petasq_ci_lower = quantile(petasq, 0.05),
              petasq_ci_upper = quantile(petasq, 0.95),
              getasq_median   = quantile(getasq, 0.50),
              getasq_ci_lower = quantile(getasq, 0.05),
              getasq_ci_upper = quantile(getasq, 0.95))

boot_estimates %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

NB 90% CIs as squared effect sizes are always positive!

## Comparing known and unknown words

### Plot

```{r, fig.height=3, fig.width=5.5}

# plot 1
data_means <- data_long_unknown_stimuli %>%
  group_by(Stimuli, trial_type) %>%
  dplyr::summarise(mean_D = mean(D),
                   se_D = std.error(D)) %>%
  round_df(2)

p2 <-
  ggplot(data_means, aes(x = trial_type, y = mean_D, colour = Stimuli)) +
  geom_linerange(aes(ymax = mean_D + (1.96*se_D),
                    ymin = mean_D + (-1.96*se_D)),
                position = position_dodge(width = .2)) +
  geom_point(aes(shape = Stimuli),
             size = 2.5,
             position = position_dodge(width = .2)) +
  geom_line(aes(group = Stimuli),
            position = position_dodge(width = .2)) +
  geom_hline(yintercept=c(0), linetype="dotted") +
  ylab(expression(paste(italic("D"), " score"))) +
  xlab("Trial type") +
  theme_minimal() +
  scale_color_viridis_d(begin = 0.3, end = 0.7)

p2

```

### Bayes Factors 

These use the equivalent of frequentist type II sum of squares model comparisons for the main effects. 

- BF for the evidence for domain is the BF(D ~ trial_type + stimuli + unique_id)/BF(D ~ trial_type + unique_id)
- BF for the evidence for trial type is the BF(D ~ trial_type + stimuli + unique_id)/BF(D ~ stimuli + unique_id)

And the equivalent of frequentist type III sum of squares model comparisons for the interaction effect.

- BF for the evidence for trial type is the BF(D ~ trial_type + stimuli + trial_type:stimuli + unique_id)/BF(D ~ trial_type + stimuli + unique_id)

```{r}

if (file.exists("models/fit_bf_anova_2.RData")) {
  
  load("models/fit_bf_anova_2.RData")
  
} else {
  
  fit_bf_anova_2 <-
    anovaBF(formula = D ~ trial_type * Stimuli + unique_id,
            data = data_long_unknown_stimuli,
            whichRandom = c("unique_id"),
            multicore = TRUE)
  
  save(fit_bf_anova_2, file = "models/fit_bf_anova_2.RData")
  
}

# BF inclusions (between multiple alternative models)
bf_inclusion_stimuli     <- fit_bf_anova_2[3] / fit_bf_anova_2[1]
bf_inclusion_trial_type   <- fit_bf_anova_2[3] / fit_bf_anova_2[2]
bf_inclusion_interaction <- fit_bf_anova_2[4] / fit_bf_anova_2[3]

```

- Stimuli BF10 = `r round(exp(bf_inclusion_stimuli@bayesFactor$bf), 2)`
- Trial type BF10 =  `r round(exp(bf_inclusion_trial_type@bayesFactor$bf), 2)`
- Interaction effect BF10 = `r round(exp(bf_inclusion_interaction@bayesFactor$bf), 2)`

### Frequentist 

```{r}

fit_anova_freq_2 <- ez::ezANOVA(data     = data_long_unknown_stimuli,
                                dv       = D,
                                within   = trial_type,
                                between  = Stimuli,
                                wid      = unique_id,
                                type     = 3,
                                detailed = TRUE)

# results
anova_out(fit_anova_freq_2, 
          etasq = "partial", 
          print = FALSE)$`--- FORMATTED RESULTS ------------------------------------` 

```

### Effect sizes

Comparison of frequentist effect sizes: eta squared, partial eta squared, and generalized eta squared.

Bootstrapping via case removal and percentile method with 2000 replications.

```{r}

if (file.exists("models/boot_fits_2.RData")) {
  
  load("models/boot_fits_2.RData")

} else {
  
  # create bootstraps using out of bag method. makes a df with values that are collapsed dfs.
  boots_2 <- data_long_unknown_stimuli %>%
    # reshape so that participants are sampled between bootstraps
    select(unique_id, stimuli, trial_type, D) %>%
    spread(trial_type, D) %>%
    rename(tt1 = `Category 1\npositive`,
           tt2 = `Category 1\nnegative`,
           tt3 = `Category 2\npositive`,
           tt4 = `Category 2\nnegative`) %>%
    # create bootstraps
    bootstraps(times = n_boots)
  
  # analysis workflow to be bootstrapped
  helper_function_2 <- function(split) {
    
    fit_anova_freq_2 <- analysis(split) %>%
      # undo reshaping
      gather(trial_type, D, c("tt1", "tt2", "tt3", "tt4")) %>%
      # fit anova
      ez::ezANOVA(data     = .,
                  dv       = D,
                  within   = trial_type,
                  between  = Stimuli,
                  wid      = unique_id,
                  type     = 3,
                  detailed = TRUE)
    
    # eta squared and generalized eta squared
    results_etasq_2 <- 
      fit_anova_freq_2$ANOVA %>%
      mutate(etasq = SSn / sum(SSn)) %>%
      select(Effect, etasq) %>%
      round_df(2)
    
    # partial eta squared
    results_petasq_and_getasq_2 <- 
      anova_out(fit_anova_freq_2, 
                etasq = "partial", 
                print = FALSE)$`--- ANOVA RESULTS     ------------------------------------` %>%
      mutate(petasq = as.numeric(as.character(petasq)),
             getasq = as.numeric(as.character(getasq))) %>%
      select(Effect, petasq, getasq)
    
    # combine
    results_proportion_of_variance_2 <- 
      left_join(results_etasq_2, results_petasq_and_getasq_2, by = "Effect")
    
    return(results_proportion_of_variance_2)
  }
  
  # apply to each bootstrap
  boot_fits_2 <- boots_2 %>% 
    mutate(fit = map(splits, helper_function_2)) %>%
    unnest(fit) 
  
  save(boot_fits_2, file = "models/boot_fits_2.RData")

}

boot_estimates_2 <- boot_fits_2 %>%
    # find CIs using percentile method
    group_by(Effect) %>%
    summarize(etasq_median    = quantile(etasq,  0.50),
              etasq_ci_lower  = quantile(etasq,  0.05),
              etasq_ci_upper  = quantile(etasq,  0.95),
              petasq_median   = quantile(petasq, 0.50),
              petasq_ci_lower = quantile(petasq, 0.05),
              petasq_ci_upper = quantile(petasq, 0.95),
              getasq_median   = quantile(getasq, 0.50),
              getasq_ci_lower = quantile(getasq, 0.05),
              getasq_ci_upper = quantile(getasq, 0.95))

boot_estimates_2 %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)

```

NB 90% CIs as squared effect sizes are always positive!

# Combined plot for manuscript

```{r fig.height=6, fig.width=6}

plot_1 <- p1 + p2 + plot_layout(ncol = 1)
plot_1

write_rds(plot_1, "models/plot_1.rds")

```

# Recommendations

Valid and invalid inferences using a hypothetical data for a commonly employed design within IRAP research (i.e., comparisons between two known groups).  

```{r fig.height=3, fig.width=6}

# data
data <- data.frame(Group = c("Intervention","Control","Intervention","Control",
                             "Intervention","Control","Intervention","Control"),
                   D = c(0.4, 0.3, 0.16, 0.13, -0.21, -0.15, -0.13, 0.15),
                   trial_type = c("White people\npositive",
                                  "White people\npositive",
                                  "White people\nnegative",
                                  "White people\nnegative",
                                  "Black people\npositive",
                                  "Black people\npositive",
                                  "Black people\nnegative",
                                  "Black people\nnegative"),
                   SE = c(0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05, 0.05)) %>%
  dplyr::mutate(trial_type = forcats::fct_relevel(as.factor(trial_type), 
                                                  "White people\npositive",
                                                  "White people\nnegative",
                                                  "Black people\npositive",
                                                  "Black people\nnegative"))

# plot
plot_2 <-
  ggplot(data, aes(x = trial_type, y = D, colour = Group)) +
  geom_linerange(aes(ymax = D + (1.96*SE),
                     ymin = D + (-1.96*SE)),
                 position = position_dodge(width = .3)) +
  geom_point(aes(shape = Group),
             size = 2.5,
             position = position_dodge(width = .3)) +
  geom_line(aes(group = Group),
            position = position_dodge(width = .3)) +
  geom_hline(yintercept = c(0), linetype = "dotted") +
  ylab(expression(paste(italic("D"), " score"))) +
  xlab("Trial type") +
  theme_classic() + 
  geom_line(data = data.frame(x = c(1, 1), y = c(0.02, 0.28)),
            aes(x = x, y = y), 
            colour = "black",
            linetype = "dashed",
            arrow = arrow(length = unit(0.20,"cm"), 
                          ends="both", 
                          type = "closed")) +
  annotate("label", x = 1, y = 0.15, label = "(a) Invalid") +
  geom_line(data = data.frame(x = c(2.96, 3.91), y = c(-0.11, 0.17)),
            aes(x = x, y = y), 
            colour = "black",
            linetype = "dashed",
            arrow = arrow(length = unit(0.20,"cm"), 
                          ends="both", 
                          type = "closed")) +
  annotate("label", x = 3.5, y = 0.10, label = "(b) Invalid") +
  geom_line(data = data.frame(x = c(4, 4), y = c(-0.111, 0.13)),
            aes(x = x, y = y), 
            colour = "black",
            linetype = "dashed",
            arrow = arrow(length = unit(0.20,"cm"), 
                          ends="both", 
                          type = "closed")) +
  annotate("label", x = 4, y = 0, label = "(c) Valid") +
  scale_color_viridis_d(begin = 0.3, end = 0.7)

plot_2

write_rds(plot_2, "models/plot_2.rds")

```



